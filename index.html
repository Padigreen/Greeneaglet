<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Greeneaglet: Inventory & Invoicing App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Libraries via CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.3/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      --main-purple: #8e44ad;
      --accent-pink: #ff69b4;
      --main-purple-dark: #5e3370;
      --main-bg: #faf6fb;
    }

    body {
      padding: 1rem;
      background: var(--main-bg);
    }
    h2, h3, h4 {
      color: var(--main-purple);
    }
    .nav-tabs .nav-link.active {
      color: #fff !important;
      background: linear-gradient(90deg, var(--main-purple), var(--accent-pink));
      border-color: var(--main-purple) var(--main-purple) #fff;
    }
    .nav-tabs .nav-link {
      color: var(--main-purple);
    }
    .btn-primary, .btn-success, .btn-outline-info, .btn-outline-secondary {
      background: linear-gradient(90deg, var(--main-purple), var(--accent-pink));
      border: none;
      color: #fff !important;
    }
    .btn-primary:hover,
    .btn-success:hover,
    .btn-outline-info:hover,
    .btn-outline-secondary:hover {
      background: var(--main-purple-dark) !important;
      color: #fff !important;
    }
    .btn-danger { background: var(--accent-pink); border: none;}
    .btn-danger:hover { background: #d13468; }
    .form-control:focus {
      border-color: var(--accent-pink);
      box-shadow: 0 0 0 .2rem #ff69b442;
    }
    table thead {
      background: linear-gradient(90deg, var(--main-purple) 70%, var(--accent-pink) 100%);
      color: #fff;
    }
    #invoice-preview {
      border: 2px solid var(--main-purple);
      background: #fff0fa;
    }
    .hide { display: none !important; }
  </style>
</head>
<body>
  <div id="login-section" class="container">
    <h2 class="mb-3">Greeneaglet Login</h2>
    <form id="login-form">
      <input type="text" id="login-username" class="form-control mb-2" placeholder="Username" required>
      <input type="password" id="login-password" class="form-control mb-2" placeholder="Password" required>
      <button type="submit" class="btn btn-primary">Login</button>
    </form>
    <div class="mt-3 text-muted small">Demo: admin/admin, rep1/rep1</div>
  </div>

  <div id="main-app" class="container hide">
    <div class="d-flex justify-content-between my-3 align-items-center">
      <h2>Greeneaglet: Inventory & Invoicing</h2>
      <span>
        <b id="current-user-info"></b>
        <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Logout</button>
      </span>
    </div>
    <ul class="nav nav-tabs" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#inventory">Inventory</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#invoicing">Invoicing</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sales-tracking">Sales Tracking</a></li>
      <li class="nav-item" id="admin-tab-li"><a class="nav-link" data-bs-toggle="tab" href="#admin-user">User Management</a></li>
    </ul>
    <div class="tab-content py-3">
      <!-- Inventory Tab -->
      <div class="tab-pane fade show active" id="inventory">
        <h3>Inventory</h3>
        <form id="item-form" class="row g-2">
          <input required type="text" class="form-control col" placeholder="Item Name" id="item-name">
          <input required type="number" min="1" class="form-control col" placeholder="Stock" id="item-qty">
          <input required type="number" min="0.01" step="0.01" class="form-control col" placeholder="Unit Price" id="item-price">
          <button class="btn btn-success col-auto" type="submit">Add/Update Item</button>
          <button class="btn btn-secondary col-auto" type="button" id="export-inventory">Export Excel</button>
          <input type="file" class="form-control col-auto" id="import-inventory" accept=".xlsx,.xls">
        </form>
        <table class="table table-bordered mt-3" id="inventory-table">
          <thead><tr><th>Item</th><th>Stock</th><th>Unit Price</th><th>Action</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <!-- Invoicing Tab -->
      <div class="tab-pane fade" id="invoicing">
        <h3>Create Invoice</h3>
        <form id="invoice-form" class="row g-2">
          <select class="form-control col" id="invoice-item"></select>
          <input required type="number" min="1" class="form-control col" placeholder="Quantity" id="invoice-qty">
          <button class="btn btn-primary col-auto" type="submit">Add to Invoice</button>
          <button type="button" class="btn btn-secondary col-auto" id="reset-invoice">New Invoice</button>
        </form>
        <div id="invoice-preview" class="border mt-3 p-3">
          <h4>Invoice Items</h4>
          <table class="table table-bordered">
            <thead><tr><th>Item</th><th>Unit Price</th><th>Qty</th><th>Subtotal</th></tr></thead>
            <tbody id="invoice-list"></tbody>
          </table>
          <div class="text-end"><strong>Total: $<span id="invoice-total">0</span></strong></div>
          <button class="btn btn-success" id="finalize-invoice">Finalize & Deduct Stock</button>
          <button class="btn btn-outline-info" id="download-invoice-pdf">Download Invoice as PDF</button>
          <button class="btn btn-outline-info" id="download-invoice-img">Download Invoice as Image</button>
        </div>
      </div>
      <!-- Sales tracking Tab -->
      <div class="tab-pane fade" id="sales-tracking">
        <h3>Sales Rep Performance</h3>
        <table class="table table-striped" id="sales-tracking-table">
          <thead><tr><th>Rep</th><th>Invoices</th><th>Total Sales</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <!-- Admin/User management Tab -->
      <div class="tab-pane fade" id="admin-user">
        <h3>User Management</h3>
        <form id="user-form" class="row g-2">
          <input required type="text" class="form-control col" placeholder="Username" id="user-username">
          <input required type="password" class="form-control col" placeholder="Password" id="user-password">
          <select class="form-control col" id="user-role">
            <option value="admin">Admin</option>
            <option value="rep">Sales Rep</option>
            <option value="viewer">Viewer</option>
          </select>
          <button class="btn btn-primary col-auto" type="submit">Add/Update User</button>
        </form>
        <table class="table mt-3" id="user-table">
          <thead><tr><th>Username</th><th>Role</th><th>Action</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  // ==== DEMO USERS, IndexedDB SETUP ====
  const db = new Dexie('greeneaglet');
  db.version(1).stores({
    users: 'username,role,password',
    inventory: 'name,stock,price',
    invoices: '++id,items,total,rep,ts'
  });

  function seedDemoUsers() {
    db.users.toCollection().count(count => {
      if (!count) {
        db.users.bulkPut([
          {username: "admin", password:"admin", role:"admin"},
          {username: "rep1", password:"rep1", role:"rep"},
          {username: "viewer", password:"view", role:"viewer"}
        ]);
      }
    });
  }
  seedDemoUsers();

  // ------------ LOGIN & USER LAYER ---------------
  let currentUser = null;
  async function tryLogin(u, p) {
    const user = await db.users.get(u);
    if (user && user.password === p) return user;
    return null;
  }

  // -- FIXED LOGIN HANDLER HERE! --
  document.getElementById('login-form').onsubmit = async function(e){
    e.preventDefault();
    let u = document.getElementById('login-username').value;
    let p = document.getElementById('login-password').value;
    let user = await tryLogin(u, p);
    if (user) {
      currentUser = user;
      document.getElementById('login-section').classList.add('hide');
      document.getElementById('main-app').classList.remove('hide');
      document.getElementById('current-user-info').textContent = `[${user.role}] ${user.username}`;
      if (user.role !== 'admin') document.getElementById('admin-tab-li').style.display = 'none';
      else document.getElementById('admin-tab-li').style.display = '';
      updateInventoryTable();
      updateUserTable();
      updateInvoiceSelect();
      updateSalesTracking();
    } else {
      alert("Invalid login!");
    }
  }

  function logout() {
    currentUser = null;
    document.getElementById('main-app').classList.add('hide');
    document.getElementById('login-section').classList.remove('hide');
  }

  // -------------- INVENTORY LOGIC --------------
  async function updateInventoryTable() {
    let inv = await db.inventory.toArray();
    let body = document.getElementById('inventory-table').querySelector('tbody');
    body.innerHTML = "";
    inv.forEach(i => {
      let tr = document.createElement('tr');
      tr.innerHTML = `<td>${i.name}</td><td>${i.stock}</td><td>$${i.price.toFixed(2)}</td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteInventory('${i.name}')">Del</button></td>`;
      body.appendChild(tr);
    });
  }

  window.deleteInventory = async function(name){
    if (!confirm("Delete item?")) return;
    await db.inventory.delete(name);
    updateInventoryTable();
    updateInvoiceSelect();
  };

  document.getElementById('item-form').onsubmit = async function(e){
    e.preventDefault();
    let item = {
      name: item-name.value.trim(),
      stock: parseInt(item-qty.value),
      price: parseFloat(item-price.value)
    }
    if (!item.name) return;
    await db.inventory.put(item);
    updateInventoryTable(); updateInvoiceSelect();
    this.reset();
  }

  // ----------- INVENTORY IMPORT/EXPORT ---------
  document.getElementById('export-inventory').onclick = async function() {
    let data = await db.inventory.toArray();
    let ws = XLSX.utils.json_to_sheet(data);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventory");
    XLSX.writeFile(wb, "inventory.xlsx");
  };

  document.getElementById('import-inventory').onchange = async function(e){
    let file = e.target.files[0];
    if (!file) return;
    let data = await file.arrayBuffer();
    let wb = XLSX.read(data);
    let rowObjs = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    for (let row of rowObjs) {
      row.price = parseFloat(row.price);
      row.stock = parseInt(row.stock);
      await db.inventory.put(row);
    }
    updateInventoryTable();
    updateInvoiceSelect();
    alert("Imported!");
  };

  // --------- INVOICE BUILDING/PREVIEW ----------
  let invoice = [];
  function updateInvoiceSelect() {
    db.inventory.toArray(inv=>{
      let sel = invoice-item;
      sel.innerHTML = inv.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
    });
  }

  document.getElementById('invoice-form').onsubmit = async function(e) {
    e.preventDefault();
    let itemName = invoice-item.value, qty = parseInt(invoice-qty.value);
    let item = await db.inventory.get(itemName);
    if (!item || qty > item.stock) {
      alert("Check stock available!");
      return;
    }
    invoice.push({name: itemName, price: item.price, qty});
    updateInvoicePreview();
    this.reset();
  };

  document.getElementById('reset-invoice').onclick = function(){
    invoice = [];
    updateInvoicePreview();
  };
  function updateInvoicePreview() {
    let table = document.getElementById('invoice-list');
    table.innerHTML = "";
    let total = 0;
    invoice.forEach((it,ix) => {
      let sub = it.price * it.qty;
      total += sub;
      let tr = document.createElement('tr');
      tr.innerHTML = `<td>${it.name}</td><td>$${it.price.toFixed(2)}</td><td>${it.qty}</td><td>$${sub.toFixed(2)}</td>`;
      table.appendChild(tr);
    });
    document.getElementById('invoice-total').textContent = total.toFixed(2);
  }

  // --------- FINALIZE INVOICE ----------
  document.getElementById('finalize-invoice').onclick = async function(){
    if (!invoice.length) return alert("No items!");
    // Deduct stock & Save invoice
    for (let line of invoice) {
      let item = await db.inventory.get(line.name);
      if (!item || line.qty > item.stock) return alert(`Insufficient stock on ${line.name}`);
      item.stock -= line.qty;
      await db.inventory.put(item);
    }
    let total = invoice.reduce((sum,i)=>sum+i.price*i.qty, 0);
    await db.invoices.add({
      items: invoice,
      total,
      rep: (currentUser || {}).username,
      ts: new Date().toISOString()
    });
    invoice = [];
    updateInventoryTable(); updateInvoicePreview(); updateSalesTracking();
    alert("Invoice finalized & stock updated!");
  };

  // --------- SHARE INVOICE (IMAGE/PDF) ---------
  document.getElementById('download-invoice-img').onclick = function(){
    html2canvas(document.getElementById('invoice-preview')).then(canvas => {
      let link = document.createElement('a');
      link.download = 'invoice.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  }
  document.getElementById('download-invoice-pdf').onclick = function(){
    html2canvas(document.getElementById('invoice-preview')).then(canvas => {
      let imgData = canvas.toDataURL('image/png');
      const pdf = new window.jspdf.jsPDF({orientation:'p',unit:'pt',format:'a4'});
      let width = pdf.internal.pageSize.getWidth();
      let height = (canvas.height * width) / canvas.width;
      pdf.addImage(imgData, 'PNG', 0, 0, width, height);
      pdf.save('invoice.pdf');
    });
  };

  // -------- SALES REPS PERFORMANCE ----------
  async function updateSalesTracking() {
    let users = await db.users.where('role').equals('rep').toArray();
    let reps = {};
    users.forEach(u=>reps[u.username] = {count:0,total:0});
    let allInvoices = await db.invoices.toArray();
    allInvoices.forEach(inv => {
      let r = inv.rep;
      if (reps[r]) {
        reps[r].count++;
        reps[r].total += inv.total;
      }
    });
    let tbody = document.getElementById('sales-tracking-table').querySelector('tbody');
    tbody.innerHTML = "";
    Object.entries(reps).forEach(([rep,val]) => {
      let tr = document.createElement('tr');
      tr.innerHTML = `<td>${rep}</td><td>${val.count}</td><td>$${val.total.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ----------- USER MANAGEMENT (ADMIN) -----------
  async function updateUserTable() {
    let users = await db.users.toArray();
    let tbody = document.getElementById('user-table').querySelector('tbody');
    tbody.innerHTML = "";
    users.forEach(u => {
      let delBtn = u.username === 'admin' ? '' :
        `<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.username}')">Del</button>`;
      let tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.username}</td><td>${u.role}</td><td>${delBtn}</td>`;
      tbody.appendChild(tr);
    });
  }

  window.deleteUser = async function(username) {
    if (username==='admin') return alert("Can't delete admin");
    if (!confirm("Are you sure?")) return;
    await db.users.delete(username);
    updateUserTable();
  };

  document.getElementById('user-form').onsubmit = async function(e){
    e.preventDefault();
    let u = user-username.value, p=user-password.value, r=user-role.value;
    await db.users.put({username:u, password:p, role:r});
    updateUserTable();
    this.reset();
  }

  </script>
</body>
  </html>
