<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Greeneaglet Lite: Mobile & Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Core Libraries -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.3/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      --purple: #8e44ad;
      --pink: #ff69b4;
      --purple-dark: #5e3370;
      --bg-lite: #f9f6fb;
      --radius-lg: 1.2rem;
    }
    body {
      background: var(--bg-lite);
      color: var(--purple-dark);
      font-family: 'Inter', Arial, sans-serif;
      min-height: 100dvh;
    }
    h1, h2, h3, h4, .navbar-brand {
      color: var(--purple)!important;
      letter-spacing: 0.02em;
    }
    .tab-pane, .container, #login-section, #main-app {
      padding-bottom: 5dvh;
    }
    .nav-tabs .nav-link.active {
      background: linear-gradient(to right, var(--purple), var(--pink));
      color: #fff!important;
      border: none;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    .nav-tabs .nav-link {
      color: var(--purple)!important;
      font-weight: bold;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    .btn-primary, .btn-success, .btn-outline-info, .btn-outline-secondary {
      background: linear-gradient(90deg, var(--purple), var(--pink));
      border: none;
      color: #fff !important;
      border-radius: var(--radius-lg);
    }
    .btn-danger {
      background: var(--pink);
      border: none;
      color: #fff;
      border-radius: var(--radius-lg);
    }
    .form-control:focus {
      border-color: var(--pink);
      box-shadow: 0 0 0 .2rem #ff69b453;
    }
    table thead {
      background: linear-gradient(90deg, var(--purple) 85%, var(--pink) 100%);
      color: #fff;
    }
    .card {
      border: none;
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 12px rgba(142,68,173,.1);
      margin-bottom: 1rem;
    }
    #invoice-preview, .card {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 1rem;
    }
    .hide { display: none!important; }
    @media (max-width: 700px) {
      h2, h3 { font-size: 1.2rem;}
      .nav-tabs .nav-link { font-size: 0.88rem;}
      .container, .tab-content {padding: 0 !important;}
      table, thead, tbody, th, td, tr { font-size: 14px!important; }
      #login-section,#main-app {padding: 0 0.2rem;}
    }
    input, select, button, label { font-size: 1em!important;}
  </style>
</head>
<body>
  <div id="login-section" class="container mt-3">
    <h2 class="mb-2 mt-3 text-center">Greeneaglet Lite Login</h2>
    <form id="login-form" class="p-2 mx-auto" style="max-width:350px;">
      <input type="text" id="login-username" autocomplete="username" class="form-control mb-2" placeholder="Username (e.g. admin)" required>
      <input type="password" id="login-password" autocomplete="current-password" class="form-control mb-2" placeholder="Password" required>
      <button type="submit" class="btn btn-primary w-100 mt-1">Log In</button>
    </form>
    <p class="text-center mt-2 text-muted">Demo: <b>admin / admin</b>, <b>rep1 / rep1</b></p>
  </div>

  <div id="main-app" class="container hide pt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3>Greeneaglet Lite</h3>
      <div>
        <span class="badge rounded-pill bg-light border text-purple px-3 py-2" id="current-user-info"></span>
        <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Logout</button>
      </div>
    </div>
    <ul class="nav nav-tabs" id="mainTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#inventory">üì¶ Inventory</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#invoicing">üßæ Invoice</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sales-tracking">üìä Sales</a></li>
      <li class="nav-item" id="admin-tab-li"><a class="nav-link" data-bs-toggle="tab" href="#admin-user">üë§ Users</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#backup">‚§¥Ô∏è Backup</a></li>
    </ul>
    <div class="tab-content py-2">
      <!-- Inventory Tab -->
      <div class="tab-pane fade show active" id="inventory">
        <h4>Inventory</h4>
        <form id="item-form" class="row g-2 align-items-end mb-2">
          <div class="col-5">
            <label>Item</label>
            <input required type="text" class="form-control" placeholder="Name" id="item-name" aria-label="Item Name">
          </div>
          <div class="col-3">
            <label>Stock</label>
            <input required type="number" min="1" class="form-control" placeholder="Qty" id="item-qty" aria-label="Quantity">
          </div>
          <div class="col-3">
            <label>Unit Price</label>
            <input required type="number" min="0.01" step="0.01" class="form-control" placeholder="$" id="item-price" aria-label="Price">
          </div>
          <div class="col-1">
            <button class="btn btn-success w-100" type="submit" aria-label="Add">‚úì</button>
          </div>
        </form>
        <div class="d-flex gap-2 pb-2 small">
          <button class="btn btn-secondary btn-sm" type="button" id="export-inventory">Export Excel</button>
          <label for="import-inventory" class="btn btn-outline-info btn-sm mb-0">Import Excel</label>
          <input type="file" class="d-none" id="import-inventory" accept=".xlsx,.xls">
        </div>
        <div class="card p-0">
          <table class="table table-bordered table-sm mb-0" id="inventory-table">
            <thead><tr><th>Item</th><th>Stock</th><th>Price</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <!-- Invoicing Tab -->
      <div class="tab-pane fade" id="invoicing">
        <h4>Create Invoice</h4>
        <form id="invoice-form" class="row g-2 align-items-end mb-2">
          <div class="col-5">
            <label>Item</label>
            <select class="form-control" id="invoice-item"></select>
          </div>
          <div class="col-3">
            <label>Qty</label>
            <input required type="number" min="1" class="form-control" placeholder="Qty" id="invoice-qty">
          </div>
          <div class="col-3">
            <label>Sales Rep</label>
            <select id="invoice-rep" class="form-control"></select>
          </div>
          <div class="col-1">
            <button class="btn btn-primary" type="submit" aria-label="Add">+</button>
          </div>
        </form>

        <div class="d-flex gap-2 pb-2 small">
          <button type="button" class="btn btn-secondary btn-sm" id="reset-invoice">New Invoice</button>
        </div>

        <div id="invoice-preview" class="card p-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <h5 class="m-0">Invoice Items</h5>
          </div>
          <table class="table table-bordered table-sm">
            <thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Subtotal</th></tr></thead>
            <tbody id="invoice-list"></tbody>
          </table>
          <div class="text-end"><strong>Total: $<span id="invoice-total">0</span></strong></div>
          <div class="row g-2 pt-2">
            <div class="col-6">
              <button class="btn btn-success w-100" id="finalize-invoice">Finalize & Deduct Stock</button>
            </div>
            <div class="col-3">
              <button class="btn btn-outline-info w-100" id="download-invoice-pdf">PDF</button>
            </div>
            <div class="col-3">
              <button class="btn btn-outline-info w-100" id="download-invoice-img">IMG</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Sales tracking Tab -->
      <div class="tab-pane fade" id="sales-tracking">
        <h4>Sales Rep Performance</h4>
        <div class="card p-2">
          <table class="table table-striped table-sm mb-0" id="sales-tracking-table">
            <thead><tr><th>Rep</th><th>Invoices</th><th>Total Sales</th><th>Avg./Sale</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card p-2 mt-2">
          <h6>My Sales (Current User)</h6>
          <table class="table table-bordered table-sm">
            <thead><tr><th>Date</th><th>Items</th><th>Total</th></tr></thead>
            <tbody id="my-sales-tbody"></tbody>
          </table>
        </div>
      </div>
      <!-- Admin/User management Tab -->
      <div class="tab-pane fade" id="admin-user">
        <h4>User Management</h4>
        <form id="user-form" class="row g-2 align-items-end mb-2">
          <div class="col-5">
            <label>Username</label>
            <input required type="text" class="form-control" placeholder="Username" id="user-username">
          </div>
          <div class="col-4">
            <label>Password</label>
            <input required type="password" class="form-control" placeholder="Password" id="user-password">
          </div>
          <div class="col-2">
            <label>Role</label>
            <select class="form-control" id="user-role">
              <option value="admin">Admin</option>
              <option value="rep">Sales Rep</option>
              <option value="viewer">Viewer</option>
            </select>
          </div>
          <div class="col-1">
            <button class="btn btn-primary w-100" type="submit" aria-label="Save">‚úì</button>
          </div>
        </form>
        <div class="card p-2 mb-0">
          <table class="table table-sm mb-0" id="user-table">
            <thead><tr><th>User</th><th>Role</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <!-- Backup & Restore -->
      <div class="tab-pane fade" id="backup">
        <h4>Backup & Restore</h4>
        <div class="card p-2 mb-2">
          <button class="btn btn-outline-info w-100 mb-2" id="export-backup">Export Backup (JSON)</button>
          <label class="btn btn-outline-secondary w-100 mb-2">
            Import Backup
            <input type="file" id="import-backup" class="d-none" accept=".json">
          </label>
          <p class="text-muted small mb-0">Back up and restore all users, inventory, invoices. Keep your file safe.</p>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========== IndexedDB ========== */
const db = new Dexie('greeneaglet-lite');
db.version(2).stores({
  users: 'username,role,password',
  inventory: 'name,stock,price',
  invoices: '++id,items,total,rep,ts'
});

function seedDemoUsers() {
  db.users.count().then(count=>{
    if(!count){
      db.users.bulkPut([
        {username: "admin", password:"admin", role:"admin"},
        {username: "rep1", password:"rep1", role:"rep"},
        {username: "viewer", password:"view", role:"viewer"}
      ]);
    }
  });
}
seedDemoUsers();

let currentUser = null;
async function tryLogin(u, p) {
  const user = await db.users.get(u);
  if (user && user.password === p) return user;
  return null;
}

document.getElementById('login-form').onsubmit = async function(e){
  e.preventDefault();
  let u = document.getElementById('login-username').value;
  let p = document.getElementById('login-password').value;
  let user = await tryLogin(u, p);
  if (user) {
    currentUser = user;
    document.getElementById('login-section').classList.add('hide');
    document.getElementById('main-app').classList.remove('hide');
    document.getElementById('current-user-info').textContent = user ? `[${user.role}] ${user.username}` : '';
    if (user.role !== 'admin') document.getElementById('admin-tab-li').style.display = 'none';
    else document.getElementById('admin-tab-li').style.display = '';
    // Load data
    updateInventoryTable();
    updateUserTable();
    updateInvoiceSelect();
    updateRepSelect();
    updateSalesTracking();
    updateMySalesTable();
  } else {
    alert("Invalid login!");
  }
}

function logout() {
  currentUser = null;
  document.getElementById('main-app').classList.add('hide');
  document.getElementById('login-section').classList.remove('hide');
}

/* ============== Inventory ============== */
async function updateInventoryTable() {
  let inv = await db.inventory.toArray();
  let body = document.getElementById('inventory-table').querySelector('tbody');
  body.innerHTML = "";
  inv.forEach(i => {
    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${i.name}</td><td>${i.stock}</td><td>$${i.price.toFixed(2)}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteInventory('${i.name}')">Del</button></td>`;
    body.appendChild(tr);
  });
}

window.deleteInventory = async function(name){
  if (!confirm("Delete item?")) return;
  await db.inventory.delete(name);
  updateInventoryTable();
  updateInvoiceSelect();
};

/* Add or Edit */
document.getElementById('item-form').onsubmit = async function(e){
  e.preventDefault();
  let item = {
    name: document.getElementById('item-name').value.trim(),
    stock: parseInt(document.getElementById('item-qty').value),
    price: parseFloat(document.getElementById('item-price').value)
  }
  if (!item.name) return;
  await db.inventory.put(item);
  updateInventoryTable(); updateInvoiceSelect();
  this.reset();
}

/* =========== Inventory Export/Import ========= */
document.getElementById('export-inventory').onclick = async function() {
  let data = await db.inventory.toArray();
  let ws = XLSX.utils.json_to_sheet(data);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Inventory");
  XLSX.writeFile(wb, "inventory.xlsx");
};

document.getElementById('import-inventory').onchange = async function(e){
  let file = e.target.files[0];
  if (!file) return;
  let data = await file.arrayBuffer();
  let wb = XLSX.read(data);
  let rowObjs = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  for (let row of rowObjs) {
    row.price = parseFloat(row.price);
    row.stock = parseInt(row.stock);
    await db.inventory.put(row);
  }
  updateInventoryTable();
  updateInvoiceSelect();
  alert("Imported!");
};

/* =============== Invoice =============== */
let invoice = [];

function updateInvoiceSelect() {
  db.inventory.toArray().then(inv=>{
    let sel = document.getElementById('invoice-item');
    sel.innerHTML = inv.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
  });
}
function updateRepSelect() {
  db.users.where('role').equals('rep').toArray().then(users => {
    let sel = document.getElementById('invoice-rep');
    sel.innerHTML = users.map(u => `<option value="${u.username}">${u.username}</option>`).join('');
    if (currentUser && currentUser.role === "rep") {
      sel.value = currentUser.username;
      sel.disabled = true;
    }
    else sel.disabled = false;
  });
}

/* Invoice Add Item */
document.getElementById('invoice-form').onsubmit = async function(e) {
  e.preventDefault();
  let itemName = document.getElementById('invoice-item').value;
  let qty = parseInt(document.getElementById('invoice-qty').value);
  let repName = document.getElementById('invoice-rep').value;
  let item = await db.inventory.get(itemName);
  if (!item || qty > item.stock) {
    alert("Check stock available!");
    return;
  }
  invoice.push({name: itemName, price: item.price, qty, rep: repName});
  updateInvoicePreview();
  this.reset();
  updateRepSelect();
};

/* Reset Invoice */
document.getElementById('reset-invoice').onclick = function(){
  invoice = [];
  updateInvoicePreview();
  if (currentUser && currentUser.role === "rep") document.getElementById('invoice-rep').value = currentUser.username;
}

/* Preview */
function updateInvoicePreview() {
  let table = document.getElementById('invoice-list');
  table.innerHTML = "";
  let total = 0;
  invoice.forEach((it,ix) => {
    let sub = it.price * it.qty;
    total += sub;
    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td>$${it.price.toFixed(2)}</td><td>${it.qty}</td><td>$${sub.toFixed(2)}</td>`;
    table.appendChild(tr);
  });
  document.getElementById('invoice-total').textContent = total.toFixed(2);
}

/* Finalize Invoice */
document.getElementById('finalize-invoice').onclick = async function(){
  if (!invoice.length) return alert("No items!");
  for (let line of invoice) {
    let item = await db.inventory.get(line.name);
    if (!item || line.qty > item.stock) return alert(`Insufficient stock for "${line.name}"`);
    item.stock -= line.qty;
    await db.inventory.put(item);
  }
  let total = invoice.reduce((sum,i)=>sum+i.price*i.qty,0);
  await db.invoices.add({
    items: invoice.map(x=>({name:x.name, price:x.price, qty:x.qty})),
    total,
    rep: document.getElementById('invoice-rep').value,
    ts: new Date().toISOString()
  });
  invoice = [];
  updateInventoryTable(); updateInvoicePreview(); updateSalesTracking(); updateMySalesTable();
  alert("Invoice saved, stock updated!");
};

/* Share as Image/PDF */
document.getElementById('download-invoice-img').onclick = function(){
  html2canvas(document.getElementById('invoice-preview')).then(canvas => {
    let link = document.createElement('a');
    link.download = 'invoice.png';
    link.href = canvas.toDataURL();
    link.click();
  });
};
document.getElementById('download-invoice-pdf').onclick = function(){
  html2canvas(document.getElementById('invoice-preview')).then(canvas => {
    let imgData = canvas.toDataURL('image/png');
    const pdf = new window.jspdf.jsPDF({orientation:'p',unit:'pt',format:'a4'});
    let width = pdf.internal.pageSize.getWidth();
    let height = (canvas.height * width) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, width, height);
    pdf.save('invoice.pdf');
  });
};

/* =========== SALES TRACKING ========== */
async function updateSalesTracking() {
  let users = await db.users.where('role').equals('rep').toArray();
  let reps = {};
  users.forEach(u=>reps[u.username] = []);
  let allInvoices = await db.invoices.toArray();
  allInvoices.forEach(inv => {
    if (reps[inv.rep]) {
      reps[inv.rep].push(inv);
    }
  });
  // Table
  let tbody = document.getElementById('sales-tracking-table').querySelector('tbody');
  tbody.innerHTML = "";
  Object.entries(reps).forEach(([rep,invs]) => {
    let total = invs.reduce((s,inv)=>s+inv.total, 0);
    let avg = invs.length ? (total/invs.length) : 0;
    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${rep}</td><td>${invs.length}</td><td>$${total.toFixed(2)}</td><td>$${avg.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

/* My Sales Table */
async function updateMySalesTable() {
  if (!currentUser || !currentUser.username) {
    document.getElementById('my-sales-tbody').innerHTML = '';
    return;
  }
  let list = await db.invoices.where('rep').equals(currentUser.username).toArray();
  list = list.sort((a,b)=>b.ts.localeCompare(a.ts));
  let tbody = document.getElementById('my-sales-tbody');
  tbody.innerHTML = "";
  list.forEach(inv=>{
    let date = new Date(inv.ts).toLocaleDateString();
    let items = inv.items.map(x=>`${x.name}(${x.qty})`).join(", ");
    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${date}</td><td>${items}</td><td>$${inv.total.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ========== USERS ========== */
async function updateUserTable() {
  let users = await db.users.toArray();
  let tbody = document.getElementById('user-table').querySelector('tbody');
  tbody.innerHTML = "";
  users.forEach(u => {
    let delBtn = u.username === 'admin' ? '' :
      `<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.username}')">Del</button>`;
    let tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.username}</td><td>${u.role}</td><td>${delBtn}</td>`;
    tbody.appendChild(tr);
  });
}

window.deleteUser = async function(username) {
  if (username==='admin') return alert("Can't delete admin");
  if (!confirm("Are you sure?")) return;
  await db.users.delete(username);
  updateUserTable();
};

document.getElementById('user-form').onsubmit = async function(e){
  e.preventDefault();
  let u = document.getElementById('user-username').value.trim();
  let p = document.getElementById('user-password').value;
  let r = document.getElementById('user-role').value;
  await db.users.put({username:u, password:p, role:r});
  updateUserTable();
  updateRepSelect();
  this.reset();
}

/* ============ BACKUP & RESTORE ============ */
document.getElementById('export-backup').onclick = async function() {
  let [users, inv, invs] = await Promise.all([
    db.users.toArray(), db.inventory.toArray(), db.invoices.toArray()
  ]);
  let blob = new Blob([JSON.stringify({users, inventory:inv, invoices:invs}, null, 2)], {type:"application/json"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  a.download = `greeneaglet-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
};
document.getElementById('import-backup').onchange = async function(e) {
  let file = e.target.files[0];
  if (!file) return;
  if (!confirm("This will overwrite all data. Continue?")) return;
  let txt = await file.text();
  try {
    let data = JSON.parse(txt);
    await db.users.clear();
    await db.inventory.clear();
    await db.invoices.clear();
    await db.users.bulkAdd(data.users || []);
    await db.inventory.bulkAdd(data.inventory || []);
    await db.invoices.bulkAdd(data.invoices || []);
    alert("Backup restored!");
    updateInventoryTable(); updateUserTable(); updateInvoiceSelect(); updateRepSelect(); updateSalesTracking(); updateMySalesTable();
  } catch(e) {
    alert("Restore failed! Invalid file?");
  }
};

/* ============= Initial Data Load ============== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
